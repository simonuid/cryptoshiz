<!-- don't judge my code pls -->
<html>
<head>
  <meta http-equiv="Access-Control-Allow-Origin" content="*">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Live Order Book</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.1/css/bulma.min.css">
  <script defer src="https://use.fontawesome.com/releases/v5.0.7/js/all.js"></script>
</head>
<body>
<script type="text/javascript">
  var symbol = "BTCUSDT"
  var url = "https://cors-anywhere.herokuapp.com/https://api.binance.com/api/v1/depth?symbol=" + symbol + "&limit=1000";
  var ws_url = "wss://stream.binance.com:9443/ws/" + symbol.toLowerCase() + "@depth";
  var lastUpdated = 0;
  var bids = {};
  var asks = {};
  var groupedBids = {};
  var groupedAsks = {};
  var maxRows = 50;
  var grouping = 0.01;
  var messageQueue = []


  var aggregateOrders = function(orders, precision, ceiling){
      if (typeof ceiling === 'undefined') { ceiling = false; }
      agg = {}
      for(var price in orders){
        // skip loop if the property is from prototype
        if (!orders.hasOwnProperty(price)) continue;

        var aggPrice;

        if(ceiling){
          aggPrice = Math.ceil( parseFloat(price) / precision ) * 1.0 * precision;
        } else {
          aggPrice = Math.floor( parseFloat(price) / precision )* 1.0 * precision;
        }

        if(typeof agg[aggPrice] === 'undefined') agg[aggPrice] = 0;
        agg[aggPrice] += parseFloat(orders[price]);
      }

      return agg;
  }

  var processUpdates = function (){
    if(messageQueue.length == 0){
      console.log('no messages to process!');
    } else if (lastUpdated == 0) {
      console.log('(still) waiting for full order book.');
    } else {
      updateOrders(messageQueue.shift());
    }
  }

  var updateOrders = function(d) {
    if(lastUpdated == 0) {
      console.log("ruh-roh, still no full order book. this shouldn't happen!");
    } else if(d.u <= lastUpdated) {
      console.log("old update, dropping");
    } else if(d.U > lastUpdated + 1 || d.u < lastUpdated + 1 ) {
      // The first processed should have U <= lastUpdateId+1 AND u >= lastUpdateId+1
      console.log("Assertion of U <= lastUpdateId+1 AND u >= lastUpdateId+1 failed ðŸ˜ž");
    } else {
      lastUpdated = d.u;
      for(level of d.a){
        // console.log(d.a);
        price = level[0]
        quant = parseFloat(level[1]);
        if(quant == 0.0){
          // console.log("Zero quantity, removing " + level[0]);
          delete asks[price];
        } else {
          // console.log("Updating " + price + "; old = " + asks[price] + ". New = " + quant);
          asks[price] = quant;
        }
      }

      // groupedAsks = aggregateOrders(asks, grouping, true);
      sortedAsks = {}
      Object.keys(asks).sort(function(a,b) { return parseFloat(a) - parseFloat(b); }).forEach(function(price){
        sortedAsks[price] = asks[price];
      });

      asks = sortedAsks;

      for(level of d.b){
        // console.log(d.b);
        price = level[0]
        quant = parseFloat(level[1]);
        if(quant == 0.0){
          // console.log("Zero quantity, removing " + level[0]);
          delete bids[price];
        } else {
          // console.log("Updating " + price + "; old = " + bids[price] + ". New = " + quant);
          bids[price] = quant;
        }
      }

      sortedBids = {}
      Object.keys(bids).sort(function(a,b) { return parseFloat(b) - parseFloat(a); }).forEach(function(price){
        sortedBids[price] = bids[price];
      });

      bids = sortedBids;
      groupedBids = aggregateOrders(bids, grouping, false);
      redraw();
    }
  }

  var arrayToObj = function(arr){
    obj = {}
    for(el of arr){
      obj[el[0]] = el[1]
    }

    return(obj);
  }

  var updateData = function(data){
    lastUpdated = data.lastUpdateId;

    bids = arrayToObj(data.bids);
    asks = arrayToObj(data.asks);
  }

  var redraw = function(){
    // clear table rows
    bids_tbody = document.getElementById('bids_table_body');
    while (bids_tbody.firstChild) {
      bids_tbody.removeChild(bids_tbody.firstChild);
    }

    asks_tbody = document.getElementById('asks_table_body');
    while (asks_tbody.firstChild) {
      asks_tbody.removeChild(asks_tbody.firstChild);
    }

    var i = 0;
    // console.log(document.getElementById('bids_table_body').innerHTML);
    Object.keys(bids).forEach(function(price){
      if(i > maxRows) return;
      i++;
      // console.log("Drawing bid");
      var row = document.getElementById('bids_table').insertRow(-1);
      var pr = row.insertCell(-1);
      var qu = row.insertCell(-1);
      pr.innerHTML = price;
      qu.innerHTML = bids[price];
    });

    var j = 0;

    for(price in asks){
      if(j > maxRows) break;
      j++;
      // console.log("Drawing bid");
      var row = document.getElementById('asks_table').insertRow(-1);
      var pr = row.insertCell(-1);
      var qu = row.insertCell(-1);
      pr.innerHTML = price;
      qu.innerHTML = asks[price];
    }

    // document.getElementById('bids').innerHTML = JSON.stringify(bids);
    // document.getElementById('asks').innerHTML = JSON.stringify(asks);
  }


  var sock = new WebSocket(ws_url);

  sock.onmessage = function(msg){
    data = JSON.parse(msg.data);
    if(data.e == 'depthUpdate'){
      messageQueue.push(data);
      processUpdates();
    }
  }

  var xmlhttp = new XMLHttpRequest();
  xmlhttp.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
      updateData(JSON.parse(this.responseText));
      redraw();
    }
  };

  xmlhttp.open('GET', url);
  xmlhttp.send();

</script>
<!-- <div id="groupings">
  Grouping:
  <a class="tag" href="#" id="pz1">0.01</a>
  <a class="tag" href="#" id="p1">0.1</a>
  <a class="tag" href="#" id="one">1</a>
  <a class="tag" href="#" id="ten">10</a>
  <a class="tag" href="#" id="hundred">100</a>
</div> -->
Max Rows:
<div class="select">
  <select onchange="maxRows = this.value == 'all' ? 99999 : this.value; redraw();">
    <option>25</option>
    <option selected>50</option>
    <option >100</option>
    <option>250</option>
    <option>500</option>
    <option value='all'>All (may rekt browser)</option>
  </select>
</div>
<div>
  <h1>Binance BTCUSDT Order Book</h1>
</div>
<div id="order_book" class="columns">
  <div id="bids" class="column is-half">
    Bids
    <table id="bids_table">
      <tbody id='bids_table_body'>
      </tbody>
    </table>
  </div>
  <div id="asks" class="column is-half">
    Asks
    <table id="asks_table">
      <tbody id='asks_table_body'>
      </tbody>
    </table>
  </div>
</div>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-8126571-11"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-8126571-11');
</script>
</body>
</html>